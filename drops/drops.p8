pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
--[[ enums
  sounds: 0  walk
          1
          2  water splat
          3  fire splat
          4  drop caught

  types.  0  rain
          1  fire
          2  snow
]]
player = {}
player.x = 60
player.y = 98
player.sprite = 0
player.speed = 2
player.direction = -1

fill_level = 0
score = 0

drops = {}
clouds = {}

function _init()
  generate_drop()
  generate_cloud()
end

function animate()
  if player.direction == -1 then
    player.sprite = 0
  else
    if player.direction == 0 then
      player.sprite = 2
    end

    if player.direction == 1 then
      player.sprite = 1
    end
    sfx(0)
  end
end

function generate_cloud()
 cloud = {}
 cloud.x = flr(rnd(127))
 cloud.y = flr(rnd(40))
 cloud.speed = .25
 cloud.sprite1 = 3
 cloud.sprite2 = 4
 cloud.sprite3 = 5
 add(clouds, cloud)
end

function draw_clouds()
  for cloud in all(clouds) do
    draw_cloud(cloud)
  end
end

function draw_cloud(cloud)
  spr(cloud.sprite1, cloud.x, cloud.y)
  spr(cloud.sprite2, cloud.x + 8, cloud.y)
  spr(cloud.sprite3, cloud.x + 16, cloud.y)
end

function generate_drop()
  drop = {}
  drop.x = flr(rnd(121))
  drop.y = 0

  perc = flr(rnd(100))
  if perc > 85 then
    if perc > 95 then
      drop.type = 1
    else
      drop.type = 2
    end
  else
    drop.type = 0
  end
  -- drop.type = flr(rnd(3)) -- 0 = rain; 1 = fire; 2 = snow flake

  drop.sprite = 16 + (16 * drop.type)
  if drop.type == 0 then
    -- common rain drop
    drop.speed = flr(rnd(2) + 1)
    drop.containment = 0.25
    drop.sound = 2
  end
  if drop.type == 1 then
    -- fire
    drop.speed = rnd(3) + 1
    drop.containment = -1
    drop.sound = 3
  end
  if drop.type == 2 then
    -- snow flake
    drop.speed = 1
    drop.containment = 0.05
    drop.sound = 2
  end

  add(drops, drop)
end

function move_clouds()
  for cloud in all(clouds) do
    cloud.x += cloud.speed
    if cloud.x > 127 then cloud.x = -24 end
  end
end

function move_drops()
-- move the drops and check collisions with surface
  for ddrop in all(drops) do
    ddrop.y += ddrop.speed

    if ddrop.y + 5 >= player.y + 4
    and ddrop.x >= player.x
    and ddrop.x <= player.x + 8 then
      score += 1
      sfx(4)
      del(drops, ddrop)
    elseif ddrop.y > 128 - fill_level then
      fill_level += ddrop.containment
      sfx(ddrop.sound)
      del(drops, ddrop)
    end
  end
end

function _update()
  player.direction = -1
  if btn(0) then player.x -= player.speed player.direction = 0 end
  if btn(1) then player.x += player.speed player.direction = 1 end
  if btn(2) then sfx(1) end

  if btnp(4) then generate_drop() end
  animate()
  move_drops()
  move_clouds()
  if fill_level < 0 then
    fill_level = 0
  end
end

function _draw()
  cls()
  map(0, 0, 0, 0, 16, 16, 0)
  spr(player.sprite,
      player.x, player.y)
  --map(15, 0, 1, 14, 1, 2, 1)

  for ddrop in all(drops) do
    spr(ddrop.sprite,
        ddrop.x, ddrop.y)
  end

  draw_clouds()

  print(score, 100, 0, 7)

  rectfill(0,128,128,128 - fill_level, 1)

  --debug info
  print("drops: "..#drops, 0, 0, 2)
  print("fill: "..fill_level, 0, 8, 2)
  print("player: "..player.x.."-"..player.y, 0, 16, 2)
  if #drops > 0 then
    print("drop: "..drops[1].x.."-"..drops[1].y, 0, 24, 2)
  end
  --

end


__gfx__
00aaa00000aaa000000aaa0000007770000077700000000000000000000077700000777000000000000000000000000000000000000000000000000000000000
0afefa000aaaf000000faaa000d666777005dd77000000007555777000d666777005dd7700000000000000000000000000000000000000000000000000000000
0aeeea000aaee000000eeaa00d6666667705666677000000666665770d6666667705666600000000000000000000000000000000000000000000000000000000
00e8e0000aa8e000000e8aa0d6666666675d66666705777077776666d6666666675d666600000000000000000000000000000000000000000000000000000000
06ccc60000cc66000066cc00d6666666675666666755667776677666d66666666756666600000000000000000000000000000000000000000000000000000000
0f444f000ccc44444444ccc05666666666d6666666566667565656555666666666d6666600000000000000000000000000000000000000000000000000000000
0c444c000cccc444444cccc005666666666666666666667165655550056666666666666600000000000000000000000000000000000000000000000000000000
0c545c000cccc440044cccc000055555555555555555111055500000000555555555555500000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000c0000000800000606060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000c0000000990000067600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
006cc000009890000675760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ccc000008980000067600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cc1000008c40000606060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00111000004c90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00099000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00989000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00898000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
008c4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
004c9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00676000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06757600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00676000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccccccccccccccccccccccccccccc00000000cccccccccccccccccccccccccccccccc00000000cccccccccccccccc00000000000000000000000000000000
cccccccc66666666666666666666666600000000ccccccccccddddcccccccccccccccccc00000000cdcdcdcdcccccccc00000000000000000000000000000000
cccccccccccccccc666666666666666600000000ccccccccccd550cccccccccccccccccc00000000cccccccccccccccc00000000000000000000000000000000
cccccccccccccccccccccccccccccccc00000000cccccccccc5550cccccccccccccccccc00000000ddddddddcccccccc00000000000000000000000000000000
cccccccccccccccccccccccc6666666600000000ccccccccccd550cccccccccccccccccc00000000cccccccccdcccdcc00000000000000000000000000000000
cccccccccccccccc666666666666666600000000ccccd0000055500000000000000dcccc00000000ddddddddcccccccc00000000000000000000000000000000
cccccccccccccccccccccccccccccccc00000000cccc0d5d5d55505d5d5d5d5d5d50cccc00000000ddddddddcccccccc00000000000000000000000000000000
cccccccccccccccccccccccc6666666600000000cccc054545555545454545454510cccc00000000dddddddddcdcdcdc00000000000000000000000000000000
dddddddd6666666666666666dddddddd00000000ccc05d55000000005555555555510ccc00000000000000000000000000000000000000000000000000000000
1d1d1d1d55555555555555551d1d1d1d00000000ccd0d544000000004444444444150dcc00000000000000000000000000000000000000000000000000000000
5555555566666666666666665555555500000000cc0d555500000000555555555d5150cc00000000000000000000000000000000000000000000000000000000
6666666666666666667766666666666600000000cd0544440000000044444444444510dc00000000000000000000000000000000000000000000000000000000
6666666666666666666667666667766600000000c05d55550000000055555555555d510c00000000000000000000000000000000000000000000000000000000
5666655556666555555666755666655500000000d0d5444400000000444444444444150d00000000000000000000000000000000000000000000000000000000
55555666555556666665555555557766000000000d5d555500000000555555555555515000000000000000000000000000000000000000000000000000000000
66666666666666666666666666666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d45ddd4566666666cccccccc0000000000000000c0d4545454545454545454545454550c44444444000000000000000000000000000000000000000000000000
1444444555555555cdcdcdcd0000000000000000c0d4444445555555444444444444450d41151555000000000000000000000000000000000000000000000000
5405554066666666cccccccc0000000000000000c0d4444445885885444444444444450c41444445000000000000000000000000000000000000000000000000
6456664567556666dddddddd0000000000000000d0d4444445805085444444444444450d41405045000000000000000000000000000000000000000000000000
6444444d66665666cccccccc0000000000000000c0d4444445555555444444444444450c41455545000000000000000000000000000000000000000000000000
5405554d56666555dddddddd0000000000000000d0d4444445805085444444444444450d41444445000000000000000000000000000000000000000000000000
5405564555576666dd5dddd50000000000000000d0d4444445555555444444444444450d41444405000000000000000000000000000000000000000000000000
6444444566666666d50ddd500000000000000000d0d4444444444444444444444444450d41444445000000000000000000000000000000000000000000000000
6456664500000000000000000000000000000000d0d4444400000000444444444444450d41444445000000000000000000000000000000000000000000000000
540555400000000000000000000000000000000010d4444400000000444444444444450d41444445000000000000000000000000000000000000000000000000
64444445000000000000000000000000000000005555555500000000555555555555555555555555000000000000000000000000000000000000000000000000
64566645000000000000000000000000000000006666666600000000666666666666666666666666000000000000000000000000000000000000000000000000
64565545000000000000000000000000000000006666666600000000666666666666666666666666000000000000000000000000000000000000000000000000
54444440000000000000000000000000000000005666655500000000566665555556666556666555000000000000000000000000000000000000000000000000
54055645000000000000000000000000000000005555566600000000555556666665555555555666000000000000000000000000000000000000000000000000
64566645000000000000000000000000000000006666666600000000666666666666666666666666000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100010000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4343434343434343434343434343434362000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4242424242424242424242424242424260000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4748404040454747464840404040404500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
57584b4b4b55575757584b4b4b4b4b5500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6668624a4a65666769684a4a4a4a4a6500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7778605350757777797850505350507500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5152705161615252526161516151615200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5251705151525261616151515152525200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0004000023610236502362015610146100b6001200003200022000220002200012000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100000000000000000000000003750077500a75010750167501b75025750267500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000100000000000000000000000000000000003e7503c7502c7503475036750387503973033720297201f710294000f4000c3000a300000000000000000000000000000000000000000000000000000000000000
000200000000000000000003f6503f6503f6503f6503f650326502a650226501b650166400f6300a6200761005610026000160001600016000160001600016000160002600026000260001600000000000000000
00010000214002a400367302f76031740357503a7503c750314001f4001c400283002a3002a3003e4003f4003f4003f4003f4003f4003f4003f4003f4003f4003430038300383000000000000000000000000000
